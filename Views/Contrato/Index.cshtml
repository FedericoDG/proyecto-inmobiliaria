@model IEnumerable<inmobiliaria.Models.Contrato>
@{
  ViewData["Title"] = "Lista de Contratos";
  Layout = "~/Views/Panel/_Layout.cshtml";
}

@if (TempData["Mensaje"] != null)
{
  <div class="alert alert-success alert-dismissible fade show text-center" role="alert">
    @TempData["Mensaje"]
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
  </div>
}


<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm border-0 bg-primary text-white">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <h1 class="card-title mb-0 fs-3">
            <i class="bi bi-file-earmark-text-fill me-2"></i>Contratos
          </h1>
          <small class="text-white-50">Listado de todos los contratos registrados</small>
        </div>
        <a class="btn btn-light btn-lg" href="/panel/contratos/crear">
          <i class="bi bi-plus-square-fill me-1"></i> Nuevo contrato
        </a>
      </div>
    </div>
  </div>
</div>


<div class="d-flex justify-content-end mb-3">
  <form method="get" class="bg-white border rounded shadow-sm p-3" style="max-width: 600px; min-width: 350px;"
    id="filtroContratos">
    @{
      var fechaDesde = Context.Request.Query["fechaDesde"].ToString();
      var fechaHasta = Context.Request.Query["fechaHasta"].ToString();
    }
    <label class="form-label fw-bold mb-2">Filtros:</label>
    <div class="row g-2 align-items-center">
      <div class="col-auto">
        <span class="input-group-text">Vigente desde</span>
      </div>
      <div class="col">
        <input type="date" name="fechaDesde" class="form-control form-control-sm" value="@fechaDesde" id="fechaDesde" />
      </div>
      <div class="col-auto">
        <span class="input-group-text">hasta</span>
      </div>
      <div class="col">
        <input type="date" name="fechaHasta" class="form-control form-control-sm" value="@fechaHasta" id="fechaHasta" />
      </div>
      <div class="col-auto">
        <span class="input-group-text">Vence en (días)</span>
      </div>
      <div class="col">
        <input type="number" name="diasVencimiento" class="form-control form-control-sm" min="1"
          placeholder="Cantidad de días" value="@Context.Request.Query["diasVencimiento"]" id="diasVencimiento" />
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary btn-sm">Filtrar</button>
      </div>
      <div class="col-auto">
        <a href="/panel/contratos" class="btn btn-outline-secondary btn-sm">Borrar filtros</a>
      </div>
    </div>
  </form>
</div>

<div class="table-responsive mb-3">
  <table class="table table-hover align-middle shadow-sm">
    <thead class="table-primary">
      <tr>
        <th scope="col">ID</th>
        <th scope="col">Inmueble</th>
        <th scope="col">Inquilino</th>
        <th scope="col">Fecha Inicio</th>
        <th scope="col">Fecha Fin Original</th>
        <th scope="col">Monto Mensual</th>
        <th scope="col">Estado</th>
        <th scope="col" class="text-center">Acciones</th>
      </tr>
    </thead>
    <tbody>
      @foreach (var c in Model)
      {
        <tr>
          <td>@c.IdContrato</td>
          <td>
            @{
              var inm = ((IEnumerable<dynamic>)ViewBag.Inmuebles)?.FirstOrDefault(i => i.IdInmueble == c.IdInmueble);
            }
            @(inm != null ? inm.Direccion : "-")
          </td>
          <td>
            @{
              var inq = ((IEnumerable<dynamic>)ViewBag.Inquilinos)?.FirstOrDefault(i => i.IdInquilino == c.IdInquilino);
            }
            @(inq != null ? inq.Nombre + " " + inq.Apellido + " (" + inq.Dni + ")" : "-")
          </td>
          <td>@c.FechaInicio.ToShortDateString()</td>
          <td>@c.FechaFinOriginal.ToShortDateString()</td>
          <td>@c.MontoMensual</td>
          <td>@c.Estado</td>
          <td class="text-center">
            <a class="btn btn-outline-info btn-sm me-1" href="/panel/contratos/detalle/@c.IdContrato"
              title="Ver detalles">
              <i class="bi bi-info-circle"></i>
            </a>
            <a class="btn btn-outline-primary btn-sm me-1" href="/panel/contratos/editar/@c.IdContrato" title="Editar">
              <i class="bi bi-pencil-square"></i>
            </a>
          </td>
        </tr>
      }
    </tbody>
  </table>
</div>

<nav aria-label="Paginación">
  <ul class="pagination justify-content-center">
    <li class="page-item @(ViewBag.Page <= 1 ? "disabled" : "")">
      <a class="page-link"
        href="?page=@(ViewBag.Page - 1)&pageSize=@ViewBag.PageSize@(ViewBag.InmuebleId != null ? "&inmuebleId=" + ViewBag.InmuebleId : "")">Anterior</a>
    </li>
    @for (int i = 1; i <= ViewBag.TotalPages; i++)
    {
      <li class="page-item @(i == ViewBag.Page ? "active" : "")">
        <a class="page-link"
          href="?page=@i&pageSize=@ViewBag.PageSize@(ViewBag.InmuebleId != null ? "&inmuebleId=" + ViewBag.InmuebleId : "")">@i</a>
      </li>
    }
    <li class="page-item @(ViewBag.Page >= ViewBag.TotalPages ? "disabled" : "")">
      <a class="page-link"
        href="?page=@(ViewBag.Page + 1)&pageSize=@ViewBag.PageSize@(ViewBag.InmuebleId != null ? "&inmuebleId=" + ViewBag.InmuebleId : "")">Siguiente</a>
    </li>
  </ul>
</nav>


@section Scripts {
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script>
    // Filtros excluyentes: si se completa uno, limpiar/deshabilitar el otro
    document.addEventListener('DOMContentLoaded', function () {
      const fechaDesde = document.getElementById('fechaDesde');
      const fechaHasta = document.getElementById('fechaHasta');
      const diasVencimiento = document.getElementById('diasVencimiento');
      const diasVencimientoPersonalizado = document.getElementById('diasVencimientoPersonalizado');
      const form = document.getElementById('filtroContratos');

      function limpiarFechas() {
        fechaDesde.value = '';
        fechaHasta.value = '';
      }
      function limpiarDias() {
        diasVencimiento.value = '';
        diasVencimientoPersonalizado.value = '';
      }

      diasVencimiento.addEventListener('change', function () {
        if (diasVencimiento.value) limpiarFechas();
      });
      diasVencimientoPersonalizado.addEventListener('input', function () {
        if (diasVencimientoPersonalizado.value) limpiarFechas();
      });
      fechaDesde.addEventListener('input', function () {
        if (fechaDesde.value || fechaHasta.value) limpiarDias();
      });
      fechaHasta.addEventListener('input', function () {
        if (fechaDesde.value || fechaHasta.value) limpiarDias();
      });

      // Eliminar inputs vacíos antes de enviar el formulario para evitar envíos innecesarios
      form.addEventListener('submit', function (e) {
        [fechaDesde, fechaHasta, diasVencimiento, diasVencimientoPersonalizado].forEach(function (input) {
          if (!input.value) input.disabled = true;
        });
        setTimeout(function () {
          [fechaDesde, fechaHasta, diasVencimiento, diasVencimientoPersonalizado].forEach(function (input) {
            input.disabled = false;
          });
        }, 1000);
      });
    });
  </script>
}
