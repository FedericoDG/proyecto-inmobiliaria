@model IEnumerable<inmobiliaria.Models.Contrato>
@{
  ViewData["Title"] = "Lista de Contratos";
  Layout = "~/Views/Panel/_Layout.cshtml";
}

@if (TempData["Mensaje"] != null)
{
  <div class="alert alert-success alert-dismissible fade show text-center" role="alert">
    @TempData["Mensaje"]
    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Cerrar"></button>
  </div>
}


<div class="row mb-4">
  <div class="col-12">
    <div class="card shadow-sm border-0 bg-primary text-white">
      <div class="card-body d-flex align-items-center justify-content-between">
        <div>
          <h1 class="card-title mb-0 fs-3">
            <i class="bi bi-file-earmark-text-fill me-2"></i>Contratos
          </h1>
          <small class="text-white-50">Listado de todos los contratos registrados</small>
        </div>
        <a class="btn btn-light btn-lg" href="/panel/contratos/crear">
          <i class="bi bi-plus-square-fill me-1"></i> Nuevo contrato
        </a>
      </div>
    </div>
  </div>
</div>

<div class="table-responsive mb-3">
  <table class="table table-hover align-middle shadow-sm">
    <thead class="table-primary">
      <tr>
        <th scope="col">ID</th>
        <th scope="col">Inquilino</th>
        <th scope="col">Inmueble</th>
        <th scope="col">Fecha Inicio</th>
        <th scope="col">Fecha Fin Original</th>
        <th scope="col">Monto Mensual</th>
        <th scope="col">Estado</th>
        <th scope="col" class="text-center">Acciones</th>
      </tr>
    </thead>
    <tbody>
      @foreach (var c in Model)
      {
        <tr>
          <td>@c.IdContrato</td>
          <td>
            @{
              var inq = ((IEnumerable<dynamic>)ViewBag.Inquilinos)?.FirstOrDefault(i => i.IdInquilino == c.IdInquilino);
            }
            @(inq != null ? inq.Nombre + " " + inq.Apellido + " (" + inq.Dni + ")" : "-")
          </td>
          <td>
            @{
              var inm = ((IEnumerable<dynamic>)ViewBag.Inmuebles)?.FirstOrDefault(i => i.IdInmueble == c.IdInmueble);
            }
            @(inm != null ? inm.Direccion : "-")
          </td>
          <td>@c.FechaInicio.ToShortDateString()</td>
          <td>@c.FechaFinOriginal.ToShortDateString()</td>
          <td>@c.MontoMensual</td>
          <td>@c.Estado</td>
          <td class="text-center">
            <a class="btn btn-outline-primary btn-sm me-1" href="/panel/contratos/editar/@c.IdContrato" title="Editar">
              <i class="bi bi-pencil-square"></i>
            </a>
            <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="modal"
              data-bs-target="#modalEliminar" data-id="@c.IdContrato" data-nombre="@c.IdContrato" title="Eliminar">
              <i class="bi bi-trash"></i>
            </button>
          </td>
        </tr>
      }
    </tbody>
  </table>
</div>

<nav aria-label="Paginación">
  <ul class="pagination justify-content-center">
    <li class="page-item @(ViewBag.Page <= 1 ? "disabled" : "")">
      <a class="page-link" href="?page=@(ViewBag.Page - 1)&pageSize=@ViewBag.PageSize">Anterior</a>
    </li>
    @for (int i = 1; i <= ViewBag.TotalPages; i++)
    {
      <li class="page-item @(i == ViewBag.Page ? "active" : "")">
        <a class="page-link" href="?page=@i&pageSize=@ViewBag.PageSize">@i</a>
      </li>
    }
    <li class="page-item @(ViewBag.Page >= ViewBag.TotalPages ? "disabled" : "")">
      <a class="page-link" href="?page=@(ViewBag.Page + 1)&pageSize=@ViewBag.PageSize">Siguiente</a>
    </li>
  </ul>
</nav>

<!-- Modal de confirmación de borrado -->
<div class="modal fade" id="modalEliminar" tabindex="-1" aria-labelledby="modalEliminarLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="modalEliminarLabel">Confirmar eliminación</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body">
        <p>¿Estás seguro que deseas eliminar el contrato <span id="nombreContrato"></span>?</p>
      </div>
      <div class="modal-footer">
        <form id="formEliminar" method="post">
          <button type="submit" class="btn btn-danger">Eliminar</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
        </form>
      </div>
    </div>
  </div>
</div>

@section Scripts {
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <script>
    const modalEliminar = document.getElementById('modalEliminar');
    modalEliminar.addEventListener('show.bs.modal', function (event) {
      const button = event.relatedTarget;
      const id = button.getAttribute('data-id');
      const nombre = button.getAttribute('data-nombre');
      document.getElementById('nombreContrato').textContent = nombre;
      const form = document.getElementById('formEliminar');
      form.action = '/panel/contratos/eliminar/' + id;
    });
  </script>
}
